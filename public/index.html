<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>O,No â€” Online</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* â”€â”€â”€ RESET & FONTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap');

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
â€“red:    #e63946;
â€“blue:   #457b9d;
â€“green:  #2a9d8f;
â€“yellow: #e9c46a;
â€“wild:   #9b5de5;
â€“bg:     #1a1a2e;
â€“surface: rgba(255,255,255,0.06);
â€“border:  rgba(255,255,255,0.12);
â€“text:   #f0f0f0;
â€“muted:  rgba(255,255,255,0.45);
â€“radius: 14px;
â€“card-w: 72px;
â€“card-h: 108px;
}

body {
font-family: â€˜Nunitoâ€™, sans-serif;
background: var(â€“bg);
color: var(â€“text);
min-height: 100vh;
overflow-x: hidden;
user-select: none;
}

/* animated mesh background */
body::before {
content:â€™â€™;
position:fixed; inset:0;
background:
radial-gradient(ellipse 60% 50% at 20% 20%, #2d1b69 0%, transparent 60%),
radial-gradient(ellipse 50% 60% at 80% 80%, #1a3a4a 0%, transparent 60%),
radial-gradient(ellipse 40% 40% at 50% 50%, #0d1b2a 0%, transparent 70%);
pointer-events:none; z-index:0;
}

/* â”€â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.screen { display:none; position:relative; z-index:1; }
.screen.active { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:20px; }

/* â”€â”€â”€ LOBBY / JOIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card-panel {
background: rgba(255,255,255,0.07);
backdrop-filter: blur(20px);
border:1px solid var(â€“border);
border-radius:24px;
padding:40px 44px;
width:100%; max-width:480px;
box-shadow: 0 24px 60px rgba(0,0,0,0.5);
}

.logo {
font-family: â€˜Fredoka Oneâ€™, cursive;
font-size:3.2em;
background: linear-gradient(135deg, #f72585, #7209b7, #4cc9f0);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
text-align:center;
margin-bottom:6px;
letter-spacing:2px;
}
.logo-sub {
text-align:center;
color:var(â€“muted);
font-size:0.9em;
margin-bottom:32px;
font-weight:600;
letter-spacing:3px;
text-transform:uppercase;
}

.field-group { margin-bottom:20px; }
.field-label { display:block; font-weight:700; font-size:0.82em; letter-spacing:1px; text-transform:uppercase; color:var(â€“muted); margin-bottom:8px; }
input[type=text], input[type=number], select {
width:100%; padding:14px 18px;
background: rgba(255,255,255,0.08);
border:1.5px solid var(â€“border);
border-radius:12px;
color:#fff; font-family:inherit; font-size:1em; font-weight:600;
outline:none; transition:border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus { border-color: rgba(155,93,229,0.7); box-shadow:0 0 0 3px rgba(155,93,229,0.15); }
input::placeholder { color:var(â€“muted); font-weight:400; }
select option { background:#1a1a2e; }

.btn {
width:100%; padding:16px;
border:none; border-radius:14px;
font-family:inherit; font-size:1.05em; font-weight:800;
cursor:pointer; transition:all 0.22s;
margin-bottom:12px; letter-spacing:0.5px;
}
.btn-primary {
background: linear-gradient(135deg, #7209b7, #4361ee);
color:#fff;
box-shadow: 0 6px 20px rgba(67,97,238,0.35);
}
.btn-primary:hover { transform:translateY(-2px); box-shadow:0 10px 28px rgba(67,97,238,0.5); }
.btn-primary:active { transform:translateY(0); }

.btn-secondary {
background: rgba(255,255,255,0.08);
color:#fff; border:1.5px solid var(â€“border);
}
.btn-secondary:hover { background:rgba(255,255,255,0.14); }

.btn-danger {
background: linear-gradient(135deg, #e63946, #c1121f);
color:#fff;
box-shadow:0 6px 20px rgba(230,57,70,0.3);
}
.btn-danger:hover { transform:translateY(-2px); }

.divider { display:flex; align-items:center; gap:12px; margin:20px 0; color:var(â€“muted); font-size:0.85em; }
.divider::before, .divider::after { content:â€™â€™; flex:1; height:1px; background:var(â€“border); }

/* â”€â”€â”€ LOBBY LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lobby-list {
max-height:260px; overflow-y:auto;
display:flex; flex-direction:column; gap:10px;
margin-bottom:20px;
}
.lobby-list::-webkit-scrollbar { width:4px; }
.lobby-list::-webkit-scrollbar-track { background:transparent; }
.lobby-list::-webkit-scrollbar-thumb { background:var(â€“border); border-radius:4px; }

.lobby-item {
display:flex; justify-content:space-between; align-items:center;
padding:14px 18px;
background:rgba(255,255,255,0.06);
border:1.5px solid var(â€“border);
border-radius:12px;
cursor:pointer; transition:all 0.2s;
}
.lobby-item:hover { background:rgba(255,255,255,0.12); border-color:rgba(155,93,229,0.5); }
.lobby-item-name { font-weight:700; font-size:1em; }
.lobby-item-info { font-size:0.8em; color:var(â€“muted); margin-top:2px; }
.lobby-item-join {
background: linear-gradient(135deg,#7209b7,#4361ee);
color:#fff; border:none; border-radius:8px;
padding:8px 16px; font-family:inherit; font-weight:700; font-size:0.85em;
cursor:pointer; transition:all 0.2s;
}
.lobby-item-join:hover { transform:scale(1.05); }

.empty-lobbies { text-align:center; color:var(â€“muted); padding:30px; font-size:0.95em; }

/* â”€â”€â”€ WAITING ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.player-slots {
display:flex; flex-direction:column; gap:10px; margin:20px 0;
}
.player-slot {
display:flex; align-items:center; gap:14px;
padding:14px 18px;
background:rgba(255,255,255,0.06);
border:1.5px solid var(â€“border);
border-radius:12px;
}
.player-slot-avatar {
width:38px; height:38px; border-radius:50%;
background:linear-gradient(135deg,#7209b7,#4361ee);
display:flex; align-items:center; justify-content:center;
font-weight:800; font-size:1em;
}
.player-slot-name { font-weight:700; flex:1; }
.player-slot-ready {
font-size:0.78em; font-weight:700; padding:5px 12px;
border-radius:20px; letter-spacing:0.5px;
}
.ready-yes { background:rgba(42,157,143,0.25); color:#2a9d8f; border:1px solid rgba(42,157,143,0.4); }
.ready-no  { background:rgba(255,255,255,0.07); color:var(â€“muted); border:1px solid var(â€“border); }

.settings-grid {
display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:16px 0;
}
.toggle-row {
display:flex; align-items:center; justify-content:space-between;
padding:12px 16px;
background:rgba(255,255,255,0.05);
border:1px solid var(â€“border); border-radius:10px;
}
.toggle-row span { font-size:0.85em; font-weight:600; color:var(â€“muted); }

.toggle { position:relative; display:inline-block; width:48px; height:26px; }
.toggle input { opacity:0; width:0; height:0; }
.toggle-track {
position:absolute; inset:0;
background:#333; border-radius:26px; transition:0.3s;
cursor:pointer;
}
.toggle-track::before {
content:â€™â€™; position:absolute;
width:20px; height:20px; border-radius:50%;
background:#fff; left:3px; top:3px; transition:0.3s;
}
.toggle input:checked + .toggle-track { background:linear-gradient(90deg,#7209b7,#4361ee); }
.toggle input:checked + .toggle-track::before { transform:translateX(22px); }

/* â”€â”€â”€ GAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#gameScreen {
display:none;
flex-direction:column;
height:100vh; max-height:100vh;
padding:12px 16px;
gap:10px;
position:relative; z-index:1;
}
#gameScreen.active { display:flex; }

/* header */
.game-header {
display:flex; align-items:center; justify-content:space-between;
flex-shrink:0;
}
.game-logo { font-family:â€˜Fredoka Oneâ€™,cursive; font-size:1.6em; color:#f72585; letter-spacing:1px; }
.game-meta {
display:flex; gap:10px; align-items:center;
}
.meta-chip {
background:rgba(255,255,255,0.08);
border:1px solid var(â€“border);
border-radius:20px; padding:6px 14px;
font-size:0.8em; font-weight:700; color:var(â€“muted);
}
.meta-chip span { color:#fff; }

/* turn banner */
.turn-banner {
text-align:center; flex-shrink:0;
font-weight:800; font-size:1em; letter-spacing:0.5px;
padding:10px 20px;
border-radius:30px;
background:rgba(255,255,255,0.07);
border:1px solid var(â€“border);
transition:all 0.4s;
}
.turn-banner.your-turn {
background:rgba(42,157,143,0.2);
border-color:rgba(42,157,143,0.6);
color:#2a9d8f;
box-shadow:0 0 20px rgba(42,157,143,0.25);
}

/* opponents row */
.opponents-area {
display:flex; gap:12px; justify-content:center;
flex-shrink:0; flex-wrap:wrap;
}

.opponent-panel {
background:rgba(255,255,255,0.06);
border:1.5px solid var(â€“border);
border-radius:16px; padding:12px 18px;
min-width:140px; text-align:center;
transition:all 0.3s;
position:relative;
}
.opponent-panel.active-turn {
border-color:rgba(249,168,37,0.7);
background:rgba(249,168,37,0.08);
box-shadow:0 0 20px rgba(249,168,37,0.2);
}
.opponent-name { font-weight:800; font-size:0.9em; margin-bottom:6px; }
.opponent-cards {
display:flex; justify-content:center; gap:-8px;
flex-wrap:wrap; min-height:40px; align-items:center;
}
.opp-card-mini {
width:26px; height:38px;
border-radius:5px;
background:linear-gradient(135deg,#2c3e50,#34495e);
border:2px solid rgba(255,255,255,0.2);
margin-left:-6px; flex-shrink:0;
box-shadow:2px 2px 6px rgba(0,0,0,0.4);
transition: all 0.3s;
}
.opp-card-mini:first-child { margin-left:0; }
.opponent-count { font-size:0.78em; color:var(â€“muted); margin-top:6px; font-weight:600; }

/* draw penalty indicator on opponent panel */
.draw-incoming {
position:absolute; top:-10px; left:50%; transform:translateX(-50%);
background:linear-gradient(135deg,#e63946,#c1121f);
color:#fff; font-weight:800; font-size:0.75em;
padding:4px 12px; border-radius:20px;
white-space:nowrap;
box-shadow:0 4px 12px rgba(230,57,70,0.5);
animation: incoming-pulse 0.6s ease-in-out infinite alternate;
pointer-events:none;
}
@keyframes incoming-pulse {
from { transform:translateX(-50%) scale(1); }
to   { transform:translateX(-50%) scale(1.08); }
}

/* play area */
.play-area {
flex:1; display:flex; align-items:center; justify-content:center;
gap:32px; position:relative;
}

/* discard pile */
.discard-zone {
position:relative;
display:flex; align-items:center; justify-content:center;
}

/* draw pile */
.draw-pile-zone {
display:flex; flex-direction:column; align-items:center; gap:8px;
cursor:pointer;
}
.draw-pile-zone:hover .pile-card { transform:scale(1.06) rotate(-3deg); }
.pile-label { font-size:0.72em; color:var(â€“muted); font-weight:700; letter-spacing:1px; text-transform:uppercase; }

/* stacked draw indicator */
.stack-indicator {
position:absolute; top:-14px; left:50%; transform:translateX(-50%);
background:linear-gradient(135deg,#f72585,#7209b7);
color:#fff; font-weight:800; font-size:0.8em;
padding:4px 14px; border-radius:20px; white-space:nowrap;
box-shadow:0 4px 12px rgba(247,37,133,0.4);
animation:stackPulse 0.8s ease-in-out infinite alternate;
}
@keyframes stackPulse {
from { box-shadow:0 4px 12px rgba(247,37,133,0.4); }
to   { box-shadow:0 4px 20px rgba(247,37,133,0.8); }
}

/* â”€â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.game-card {
width: var(â€“card-w);
height: var(â€“card-h);
border-radius:10px;
border:3px solid rgba(255,255,255,0.9);
display:flex; flex-direction:column;
align-items:center; justify-content:center;
box-shadow:0 6px 18px rgba(0,0,0,0.45);
position:relative; flex-shrink:0;
transition:transform 0.2s, box-shadow 0.2s;
overflow:hidden;
}

.game-card::before {
content:â€™â€™;
position:absolute; inset:8px;
border:2px solid rgba(255,255,255,0.35);
border-radius:6px; pointer-events:none;
}

.game-card.red    { background:linear-gradient(145deg,#e63946,#c1121f); }
.game-card.blue   { background:linear-gradient(145deg,#457b9d,#1d3557); }
.game-card.green  { background:linear-gradient(145deg,#2a9d8f,#1a7a6e); }
.game-card.yellow { background:linear-gradient(145deg,#e9c46a,#f4a261); }
.game-card.wild   {
background:conic-gradient(#e63946 0deg 90deg,#457b9d 90deg 180deg,#2a9d8f 180deg 270deg,#e9c46a 270deg 360deg);
}

.card-value {
font-family:â€˜Fredoka Oneâ€™,cursive;
font-size:2em; color:#fff;
text-shadow:0 2px 8px rgba(0,0,0,0.5);
line-height:1;
}
.card-value.small { font-size:1.15em; }
.card-corner {
position:absolute; font-family:â€˜Fredoka Oneâ€™,cursive;
font-size:0.75em; color:rgba(255,255,255,0.85);
line-height:1;
}
.card-corner.tl { top:5px; left:7px; }
.card-corner.br { bottom:5px; right:7px; transform:rotate(180deg); }

/* player hand cards */
.pile-card {
width:var(â€“card-w); height:var(â€“card-h);
background:linear-gradient(135deg,#1e3a5f,#2c3e50);
border:3px solid rgba(255,255,255,0.7);
border-radius:10px;
display:flex; align-items:center; justify-content:center;
font-size:2em;
box-shadow:0 8px 24px rgba(0,0,0,0.5);
transition:transform 0.2s;
position:relative;
}
.pile-card::after {
content:â€˜O,Noâ€™;
font-family:â€˜Fredoka Oneâ€™,cursive;
font-size:0.4em; color:rgba(255,255,255,0.4);
position:absolute; bottom:8px; letter-spacing:1px;
}

/* player hand */
.player-area { flex-shrink:0; }
.player-label {
text-align:center; font-size:0.8em; font-weight:700;
color:var(â€“muted); letter-spacing:1px; text-transform:uppercase;
margin-bottom:10px;
}
.player-hand {
display:flex; justify-content:center; flex-wrap:nowrap;
overflow-x:auto; gap:8px; padding:8px 4px;
scrollbar-width:none;
}
.player-hand::-webkit-scrollbar { display:none; }

.hand-card {
width:var(â€“card-w); height:var(â€“card-h);
flex-shrink:0; cursor:pointer;
transition:transform 0.2s, box-shadow 0.2s, filter 0.2s;
}
.hand-card:hover { transform:translateY(-16px) scale(1.06); box-shadow:0 14px 28px rgba(0,0,0,0.5); }
.hand-card.unplayable { filter:brightness(0.45) saturate(0.3); cursor:not-allowed; pointer-events:none; }
.hand-card.unplayable:hover { transform:none; }

/* controls */
.controls-bar {
display:flex; align-items:center; justify-content:space-between;
gap:10px; flex-shrink:0;
}
.ono-button {
background:linear-gradient(135deg,#e63946,#9b2335);
color:#fff; border:none; border-radius:30px;
padding:14px 32px; font-family:â€˜Fredoka Oneâ€™,cursive;
font-size:1.3em; cursor:pointer; letter-spacing:1px;
box-shadow:0 6px 20px rgba(230,57,70,0.45);
transition:all 0.2s;
display:none;
}
.ono-button.visible { display:block; }
.ono-button:hover { transform:scale(1.08); box-shadow:0 8px 28px rgba(230,57,70,0.65); }
.ono-button.pulse { animation:onoPulse 0.6s ease-in-out infinite alternate; }
@keyframes onoPulse {
from { transform:scale(1); }
to   { transform:scale(1.12); }
}

.leave-btn {
background:rgba(255,255,255,0.07); color:var(â€“muted);
border:1px solid var(â€“border); border-radius:10px;
padding:10px 18px; font-family:inherit; font-size:0.85em;
font-weight:700; cursor:pointer; transition:all 0.2s;
}
.leave-btn:hover { background:rgba(230,57,70,0.15); color:var(â€“red); border-color:var(â€“red); }

/* message toast */
.message-toast {
position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-80px);
background:rgba(30,30,50,0.95); backdrop-filter:blur(12px);
border:1px solid var(â€“border); border-radius:30px;
padding:12px 28px; font-weight:700; font-size:0.95em;
z-index:999; pointer-events:none;
transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1), opacity 0.35s;
opacity:0; white-space:nowrap;
box-shadow:0 8px 30px rgba(0,0,0,0.5);
}
.message-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
.message-toast.draw-alert { border-color:rgba(230,57,70,0.6); color:#ff6b6b; }
.message-toast.good { border-color:rgba(42,157,143,0.6); color:#2a9d8f; }

/* â”€â”€â”€ COLOR PICKER OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
display:none; position:fixed; inset:0;
background:rgba(0,0,0,0.7); backdrop-filter:blur(6px);
z-index:900;
}
.overlay.active { display:block; }

.color-picker {
display:none; position:fixed;
top:50%; left:50%; transform:translate(-50%,-50%);
background:rgba(20,20,40,0.97);
border:1px solid var(â€“border); border-radius:24px;
padding:32px 36px; z-index:901;
box-shadow:0 24px 60px rgba(0,0,0,0.6);
text-align:center;
}
.color-picker.active { display:block; }
.color-picker h3 { margin-bottom:24px; font-size:1.1em; color:var(â€“muted); font-weight:700; letter-spacing:1px; text-transform:uppercase; }
.color-options { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.color-option {
width:80px; height:80px; border-radius:16px; cursor:pointer;
border:3px solid transparent; transition:all 0.2s;
position:relative; overflow:hidden;
}
.color-option:hover { transform:scale(1.12); border-color:#fff; }
.color-option::after { content:attr(data-label); position:absolute; bottom:6px; left:0; right:0; text-align:center; font-family:â€˜Fredoka Oneâ€™,cursive; font-size:0.8em; color:rgba(255,255,255,0.9); }
.color-option.red    { background:linear-gradient(135deg,#e63946,#c1121f); }
.color-option.blue   { background:linear-gradient(135deg,#457b9d,#1d3557); }
.color-option.green  { background:linear-gradient(135deg,#2a9d8f,#1a7a6e); }
.color-option.yellow { background:linear-gradient(135deg,#e9c46a,#f4a261); }

/* â”€â”€â”€ GAME OVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.game-over-panel {
display:none; position:fixed;
top:50%; left:50%; transform:translate(-50%,-50%);
background:rgba(20,20,40,0.97);
border:1px solid var(â€“border); border-radius:24px;
padding:44px 48px; z-index:910; text-align:center;
box-shadow:0 24px 60px rgba(0,0,0,0.7);
min-width:300px;
}
.game-over-panel.active { display:block; }
.game-over-emoji { font-size:3.5em; margin-bottom:16px; }
.game-over-title { font-family:â€˜Fredoka Oneâ€™,cursive; font-size:2.2em; margin-bottom:10px; }
.game-over-title.win  { color:#2a9d8f; }
.game-over-title.lose { color:#e63946; }
.game-over-sub { color:var(â€“muted); margin-bottom:28px; font-size:0.95em; }

/* â”€â”€â”€ DRAW ANIMATION LAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#animationLayer {
position:fixed; inset:0; pointer-events:none; z-index:800;
overflow:hidden;
}

/* Flying card used for draw animations */
.fly-card {
position:absolute;
width:50px; height:74px;
border-radius:8px;
border:2.5px solid rgba(255,255,255,0.85);
box-shadow:0 6px 20px rgba(0,0,0,0.55);
display:flex; align-items:center; justify-content:center;
font-family:â€˜Fredoka Oneâ€™,cursive;
font-size:1.15em; color:#fff;
pointer-events:none;
/* Start state â€” placed by JS */
animation: none;
will-change: transform, opacity;
}

/* The â€œburstâ€ ring shown on the target area */
.draw-burst {
position:absolute;
width:80px; height:80px;
border-radius:50%;
border:3px solid currentColor;
pointer-events:none;
animation: burstRing 0.6s ease-out forwards;
}
@keyframes burstRing {
0%   { transform:translate(-50%,-50%) scale(0.4); opacity:1; }
100% { transform:translate(-50%,-50%) scale(2.4); opacity:0; }
}

/* label that floats up over the target */
.draw-count-pop {
position:absolute;
font-family:â€˜Fredoka Oneâ€™,cursive;
font-size:1.5em; color:#fff;
text-shadow:0 2px 8px rgba(0,0,0,0.6);
pointer-events:none;
animation: countPop 1.1s ease-out forwards;
transform-origin:center bottom;
}
@keyframes countPop {
0%   { transform:translate(-50%,-50%) scale(0.4); opacity:0; }
20%  { transform:translate(-50%,-100%) scale(1.2); opacity:1; }
60%  { transform:translate(-50%,-130%) scale(1);   opacity:1; }
100% { transform:translate(-50%,-180%) scale(0.8); opacity:0; }
}

/* shake animation for the victimâ€™s panel */
@keyframes shakePanel {
0%,100%{ transform:translateX(0); }
15%    { transform:translateX(-8px) rotate(-1deg); }
30%    { transform:translateX(8px) rotate(1deg); }
45%    { transform:translateX(-6px); }
60%    { transform:translateX(6px); }
75%    { transform:translateX(-3px); }
88%    { transform:translateX(3px); }
}
.shake { animation:shakePanel 0.55s ease-in-out; }

/* new card flash for local player when they receive cards */
@keyframes handFlash {
0%  { box-shadow:0 0 0 0 rgba(230,57,70,0.0); }
30% { box-shadow:0 0 0 12px rgba(230,57,70,0.55); }
100%{ box-shadow:0 0 0 0 rgba(230,57,70,0.0); }
}
.flash-draw { animation:handFlash 0.7s ease-out; }

/* catch uno button */
.catch-buttons {
display:flex; gap:8px; flex-wrap:wrap; justify-content:center;
margin-top:6px;
}
.catch-btn {
background:rgba(230,57,70,0.15);
color:#e63946; border:1.5px solid rgba(230,57,70,0.4);
border-radius:8px; padding:7px 14px;
font-family:inherit; font-weight:800; font-size:0.78em;
cursor:pointer; transition:all 0.2s;
}
.catch-btn:hover { background:rgba(230,57,70,0.3); }

/* color badge on discard */
.color-badge {
position:absolute; bottom:-24px; left:50%; transform:translateX(-50%);
font-size:0.72em; font-weight:700; text-transform:uppercase; letter-spacing:1px;
padding:3px 12px; border-radius:12px;
background:rgba(0,0,0,0.5); color:#fff;
white-space:nowrap;
}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:500px) {
:root { â€“card-w:58px; â€“card-h:86px; }
.card-value { font-size:1.6em; }
.game-logo  { font-size:1.2em; }
.card-panel { padding:28px 22px; }
}
</style>

</head>
<body>

<!-- Animation layer (always on top) -->

<div id="animationLayer"></div>

<!-- Toast -->

<div class="message-toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: MAIN MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="menuScreen" class="screen active">
  <div class="card-panel">
    <div class="logo">O,No!</div>
    <div class="logo-sub">Online Multiplayer</div>

```
<div class="field-group">
  <label class="field-label">Your Name</label>
  <input type="text" id="playerName" placeholder="Enter your nameâ€¦" maxlength="20">
</div>

<button class="btn btn-primary" onclick="goToLobbies()">Browse Lobbies</button>
<button class="btn btn-secondary" onclick="goToCreate()">Create Lobby</button>
```

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: LOBBY BROWSER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="browseScreen" class="screen">
  <div class="card-panel" style="max-width:520px;">
    <div class="logo" style="font-size:2em;margin-bottom:4px;">Lobbies</div>
    <div class="logo-sub" style="margin-bottom:20px;">Join a game</div>

```
<div class="lobby-list" id="lobbyList">
  <div class="empty-lobbies">No lobbies found. Create one!</div>
</div>

<button class="btn btn-secondary" onclick="refreshLobbies()">â†» Refresh</button>
<div class="divider">or</div>
<button class="btn btn-primary" onclick="goToCreate()">+ Create Lobby</button>
<button class="btn btn-secondary" onclick="goToMenu()">â† Back</button>
```

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: CREATE LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="createScreen" class="screen">
  <div class="card-panel" style="max-width:520px;">
    <div class="logo" style="font-size:2em;margin-bottom:4px;">New Lobby</div>
    <div class="logo-sub" style="margin-bottom:20px;">Configure your game</div>

```
<div class="field-group">
  <label class="field-label">Lobby Name</label>
  <input type="text" id="lobbyName" placeholder="My awesome gameâ€¦" maxlength="30">
</div>

<div class="field-group">
  <label class="field-label">Max Players</label>
  <select id="maxPlayers">
    <option value="3">3 Players</option>
    <option value="4" selected>4 Players</option>
    <option value="5">5 Players</option>
    <option value="6">6 Players</option>
  </select>
</div>

<div class="settings-grid">
  <div class="toggle-row">
    <span>Stacking</span>
    <label class="toggle"><input type="checkbox" id="settingStacking"><span class="toggle-track"></span></label>
  </div>
  <div class="toggle-row">
    <span>Jumpâ€‘In</span>
    <label class="toggle"><input type="checkbox" id="settingJumpIn"><span class="toggle-track"></span></label>
  </div>
  <div class="toggle-row">
    <span>0 & 7 Swap</span>
    <label class="toggle"><input type="checkbox" id="settingSpecial07"><span class="toggle-track"></span></label>
  </div>
  <div class="toggle-row">
    <span>4 & 8 Special</span>
    <label class="toggle"><input type="checkbox" id="settingSpecial48"><span class="toggle-track"></span></label>
  </div>
  <div class="toggle-row" style="grid-column:1/-1;">
    <span>Draw Until Match</span>
    <label class="toggle"><input type="checkbox" id="settingDrawUntilMatch" checked><span class="toggle-track"></span></label>
  </div>
</div>

<button class="btn btn-primary" onclick="createLobby()">Create & Wait</button>
<button class="btn btn-secondary" onclick="goToMenu()">â† Back</button>
```

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: WAITING ROOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="waitingScreen" class="screen">
  <div class="card-panel" style="max-width:500px;">
    <div class="logo" style="font-size:2em;margin-bottom:4px;" id="waitingLobbyName">Lobby</div>
    <div class="logo-sub" style="margin-bottom:20px;">Waiting for players (min 3)</div>

```
<div class="player-slots" id="playerSlots"></div>

<div style="margin:16px 0 20px;">
  <button class="btn btn-primary" id="readyBtn" onclick="toggleReady()">âœ“ Ready Up</button>
</div>
<button class="btn btn-secondary" onclick="leaveLobby()">â† Leave</button>
```

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN: GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div id="gameScreen" class="screen">

  <div class="game-header">
    <div class="game-logo">O,No!</div>
    <div class="game-meta">
      <div class="meta-chip">ğŸƒ Deck: <span id="deckCount">â€”</span></div>
      <div class="meta-chip" id="colorChip">Color: <span id="currentColorLabel">â€”</span></div>
    </div>
  </div>

  <div class="turn-banner" id="turnBanner">Waitingâ€¦</div>

  <!-- opponents -->

  <div class="opponents-area" id="opponentsArea"></div>

  <!-- catch buttons -->

  <div class="catch-buttons" id="catchButtons"></div>

  <!-- play area -->

  <div class="play-area">
    <div class="draw-pile-zone" id="drawPileZone" onclick="drawCard()">
      <div class="pile-card" id="drawPileCard">ğŸ´</div>
      <div class="pile-label">Draw</div>
    </div>

```
<div class="discard-zone" id="discardZone" style="position:relative;">
  <!-- discard card rendered here -->
  <div id="discardCard"></div>
  <div class="color-badge" id="colorBadge" style="display:none;"></div>
</div>
```

  </div>

  <!-- player hand -->

  <div class="player-area">
    <div class="player-label" id="playerLabel">Your Hand</div>
    <div class="player-hand" id="playerHand"></div>
  </div>

  <!-- controls -->

  <div class="controls-bar">
    <button class="leave-btn" onclick="leaveGame()">âœ• Leave</button>
    <button class="ono-button" id="onoButton" onclick="callOno()">O,No!</button>
    <div style="width:70px;"></div><!-- spacer -->
  </div>

</div>

<!-- â”€â”€â”€ Overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

<div class="overlay" id="overlay"></div>

<div class="color-picker" id="colorPicker">
  <h3>Choose a Color</h3>
  <div class="color-options">
    <div class="color-option red"    data-label="Red"    onclick="pickColor('red')"></div>
    <div class="color-option blue"   data-label="Blue"   onclick="pickColor('blue')"></div>
    <div class="color-option green"  data-label="Green"  onclick="pickColor('green')"></div>
    <div class="color-option yellow" data-label="Yellow" onclick="pickColor('yellow')"></div>
  </div>
</div>

<div class="game-over-panel" id="gameOverPanel">
  <div class="game-over-emoji" id="gameOverEmoji">ğŸ‰</div>
  <div class="game-over-title" id="gameOverTitle">You Win!</div>
  <div class="game-over-sub"   id="gameOverSub"></div>
  <button class="btn btn-primary" onclick="leaveGame()" style="max-width:220px;margin:0 auto;">Back to Menu</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<script>
/* â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const socket = io();

let myName    = '';
let myRoomId  = null;
let isReady   = false;
let gameState = null;
let prevState = null;      // previous gameState for diff-based animation
let pendingCardIndex = null;
let heartbeatInterval = null;

/* â”€â”€â”€ Screen helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* â”€â”€â”€ Toast / message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let toastTimer = null;
function showToast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className   = 'message-toast' + (type ? ' ' + type : '') + ' show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

/* â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function goToMenu()    { showScreen('menuScreen'); }
function goToCreate()  {
  myName = document.getElementById('playerName').value.trim();
  if (!myName) { showToast('Enter your name first!'); return; }
  showScreen('createScreen');
}
function goToLobbies() {
  myName = document.getElementById('playerName').value.trim();
  if (!myName) { showToast('Enter your name first!'); return; }
  showScreen('browseScreen');
  refreshLobbies();
}

function refreshLobbies() { socket.emit('requestLobbies'); }

function createLobby() {
  const name = document.getElementById('lobbyName').value.trim() || myName + "'s Game";
  const settings = {
    maxPlayers:      parseInt(document.getElementById('maxPlayers').value),
    allowStacking:   document.getElementById('settingStacking').checked,
    allowJumpIn:     document.getElementById('settingJumpIn').checked,
    allowSpecial07:  document.getElementById('settingSpecial07').checked,
    allowSpecial48:  document.getElementById('settingSpecial48').checked,
    drawUntilMatch:  document.getElementById('settingDrawUntilMatch').checked,
  };
  socket.emit('createLobby', { lobbyName: name, playerName: myName, settings });
}

function toggleReady() {
  isReady = !isReady;
  const btn = document.getElementById('readyBtn');
  btn.textContent = isReady ? 'âœ• Cancel Ready' : 'âœ“ Ready Up';
  btn.className   = isReady ? 'btn btn-danger' : 'btn btn-primary';
  socket.emit('playerReady', { roomId: myRoomId, ready: isReady });
}

function leaveLobby() {
  myRoomId = null; isReady = false;
  goToMenu();
}
function leaveGame() {
  clearInterval(heartbeatInterval);
  myRoomId = null;
  goToMenu();
}

/* â”€â”€â”€ SOCKET EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

socket.on('lobbyList', lobbies => {
  const el = document.getElementById('lobbyList');
  if (!lobbies.length) {
    el.innerHTML = '<div class="empty-lobbies">No open lobbies. Create one!</div>';
    return;
  }
  el.innerHTML = lobbies.map(l => `
    <div class="lobby-item">
      <div>
        <div class="lobby-item-name">${escHtml(l.name)}</div>
        <div class="lobby-item-info">${l.players.length}/${l.settings.maxPlayers} players</div>
      </div>
      <button class="lobby-item-join" onclick="joinLobby('${l.id}')">Join</button>
    </div>
  `).join('');
});

function joinLobby(lobbyId) {
  socket.emit('joinLobby', { lobbyId, playerName: myName });
}

socket.on('lobbyCreated', data => {
  myRoomId = data.roomId;
  document.getElementById('waitingLobbyName').textContent = data.lobbyName;
  renderPlayerSlots(data.players);
  showScreen('waitingScreen');
  startHeartbeat();
});

socket.on('lobbyJoined', data => {
  myRoomId = data.roomId;
  document.getElementById('waitingLobbyName').textContent = data.lobbyName;
  renderPlayerSlots(data.players);
  showScreen('waitingScreen');
  startHeartbeat();
});

socket.on('lobbyUpdate', data => {
  renderPlayerSlots(data.players);
});

function renderPlayerSlots(players) {
  const el = document.getElementById('playerSlots');
  el.innerHTML = players.map(p => `
    <div class="player-slot">
      <div class="player-slot-avatar">${escHtml(p.name[0].toUpperCase())}</div>
      <div class="player-slot-name">${escHtml(p.name)}</div>
      <div class="player-slot-ready ${p.ready ? 'ready-yes' : 'ready-no'}">${p.ready ? 'Ready' : 'Waiting'}</div>
    </div>
  `).join('');
}

socket.on('gameStarted', state => {
  gameState = state;
  prevState = null;
  showScreen('gameScreen');
  renderGame(state);
});

socket.on('gameState', state => {
  prevState = gameState;
  gameState = state;
  renderGame(state);
});

socket.on('playerCalledUno', data => {
  showToast(`ğŸƒ ${data.playerName} called O,No!`, 'draw-alert');
});

socket.on('unoPenalty', data => {
  showToast(`âš ï¸ ${data.message}`, 'draw-alert');
});

socket.on('playerDisconnected', data => {
  showToast(`âš ï¸ ${data.playerName} disconnected`);
});

socket.on('playerTimeout', data => {
  showToast(`â±ï¸ ${data.playerName} was removed`);
});

socket.on('gameEnded', data => {
  showGameOver(false, data.message || 'Game ended');
});

socket.on('gameOver', data => {
  const won = data.winnerId === socket.id;
  showGameOver(won, won ? `You beat everyone! ğŸ†` : `${data.winner} wins!`);
});

socket.on('error', msg => { showToast(`âŒ ${msg}`); });

/* â”€â”€â”€ Draw Penalty Animation Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/*
  Payload: {
    targetPlayerId, targetPlayerName, count,
    playedByName, cardValue, isStackedDraw, stateDelay
  }
*/
socket.on('drawPenaltyAnimation', data => {
  const isMe = data.targetPlayerId === socket.id;
  triggerDrawAnimation(data, isMe);
});

/* â”€â”€â”€ RENDER GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderGame(state) {
  if (!state) return;

  /* Deck count */
  document.getElementById('deckCount').textContent = state.deckCount;

  /* Turn banner */
  const banner = document.getElementById('turnBanner');
  if (state.isYourTurn) {
    banner.textContent = 'â­ Your Turn';
    banner.classList.add('your-turn');
  } else {
    banner.textContent = `${state.currentPlayerName}'s Turn`;
    banner.classList.remove('your-turn');
  }

  /* Current color chip */
  const colorChip = document.getElementById('currentColorLabel');
  const colorNames = { red:'ğŸ”´ Red', blue:'ğŸ”µ Blue', green:'ğŸŸ¢ Green', yellow:'ğŸŸ¡ Yellow', wild:'ğŸŒˆ Wild' };
  colorChip.textContent = colorNames[state.currentColor] || state.currentColor || 'â€”';

  /* Stacking draw count */
  const drawPileCard = document.getElementById('drawPileCard');
  const existingStack = drawPileCard.querySelector('.stack-indicator');
  if (existingStack) existingStack.remove();
  if (state.stackedDrawCount > 0) {
    const ind = document.createElement('div');
    ind.className = 'stack-indicator';
    ind.textContent = `+${state.stackedDrawCount} Stack`;
    drawPileCard.appendChild(ind);
  }

  /* Discard pile */
  renderDiscard(state.discardPile, state.currentColor);

  /* Opponents */
  renderOpponents(state.opponents, state.currentPlayer, state.yourName);

  /* Catch buttons */
  renderCatchButtons(state.opponents);

  /* Player hand */
  renderHand(state.yourHand, state.isYourTurn, state.settings, state.stackedDrawCount, state.currentColor, state.currentValue);

  /* O,No button */
  const onoBtn = document.getElementById('onoButton');
  if (state.yourHand && (state.yourHand.length === 2 || state.yourHand.length === 1)) {
    onoBtn.classList.add('visible');
    if (state.yourHand.length === 2 && state.isYourTurn) onoBtn.classList.add('pulse');
    else onoBtn.classList.remove('pulse');
  } else {
    onoBtn.classList.remove('visible','pulse');
  }
}

function renderDiscard(card, currentColor) {
  const el = document.getElementById('discardCard');
  const badge = document.getElementById('colorBadge');
  if (!card) { el.innerHTML = ''; badge.style.display='none'; return; }

  el.innerHTML = '';
  const div = buildCard(card);
  div.style.width  = '90px';
  div.style.height = '134px';
  div.style.cursor = 'default';
  el.appendChild(div);

  if (card.type === 'wild' && currentColor && currentColor !== 'wild') {
    badge.textContent = currentColor.toUpperCase();
    badge.style.display = '';
    badge.style.background = cardColorHex(currentColor);
  } else {
    badge.style.display = 'none';
  }
}

function renderOpponents(opponents, currentPlayerIndex, myName) {
  const area = document.getElementById('opponentsArea');
  if (!opponents || !opponents.length) { area.innerHTML = ''; return; }

  // currentPlayerIndex is an index into the room's players array
  // We need to check by player name/id â€” gameState includes currentPlayerName
  const currentName = gameState?.currentPlayerName;

  area.innerHTML = '';
  opponents.forEach(opp => {
    const panel = document.createElement('div');
    panel.className = 'opponent-panel';
    panel.id = `opp-${opp.id}`;
    if (opp.name === currentName) panel.classList.add('active-turn');

    const miniCards = Math.min(opp.cardCount, 12);
    let cardsHtml = '';
    for (let i = 0; i < miniCards; i++) {
      cardsHtml += `<div class="opp-card-mini" style="margin-left:${i===0?0:-6}px"></div>`;
    }

    panel.innerHTML = `
      <div class="opponent-name">${escHtml(opp.name)}</div>
      <div class="opponent-cards" id="oppCards-${opp.id}">${cardsHtml}</div>
      <div class="opponent-count">${opp.cardCount} card${opp.cardCount !== 1 ? 's' : ''}</div>
    `;
    area.appendChild(panel);
  });
}

function renderCatchButtons(opponents) {
  const el = document.getElementById('catchButtons');
  el.innerHTML = '';
  if (!opponents) return;
  opponents.forEach(opp => {
    const btn = document.createElement('button');
    btn.className = 'catch-btn';
    btn.textContent = `Catch ${opp.name}!`;
    btn.onclick = () => catchOno(opp.id);
    el.appendChild(btn);
  });
}

function renderHand(hand, isMyTurn, settings, stackedDrawCount, currentColor, currentValue) {
  const el = document.getElementById('playerHand');
  el.innerHTML = '';
  if (!hand) return;

  hand.forEach((card, i) => {
    const div = buildCard(card);
    div.classList.add('hand-card');

    const playable = isMyTurn && canPlay(card, currentColor, currentValue, settings, stackedDrawCount);
    if (!playable) div.classList.add('unplayable');
    else div.onclick = () => playCard(i, card);

    el.appendChild(div);
  });
}

/* â”€â”€â”€ Card builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildCard(card) {
  const div = document.createElement('div');
  div.className = `game-card ${card.color}`;

  const val  = cardDisplay(card);
  const small = val.length > 2;

  div.innerHTML = `
    <div class="card-corner tl">${val}</div>
    <div class="card-value${small?' small':''}">${val}</div>
    <div class="card-corner br">${val}</div>
  `;
  return div;
}

function cardDisplay(card) {
  const map = { 'Wild+4':'W+4', 'Wild':'W', 'Skip':'âŠ˜', 'Reverse':'â†º', '+2':'+2' };
  return map[card.value] || card.value;
}

function cardColorHex(color) {
  return { red:'#e63946', blue:'#457b9d', green:'#2a9d8f', yellow:'#e9c46a' }[color] || '#555';
}

/* â”€â”€â”€ Playability check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function canPlay(card, currentColor, currentValue, settings, stackedDrawCount) {
  if (card.type === 'wild') return true;
  if (settings && settings.allowStacking && stackedDrawCount > 0) {
    if (currentValue === '+2'     && card.value === '+2')     return true;
    if (currentValue === 'Wild+4' && card.value === 'Wild+4') return true;
    return false;
  }
  return card.color === currentColor || card.value === currentValue;
}

/* â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function playCard(index, card) {
  if (!gameState?.isYourTurn) return;
  if (card.type === 'wild') {
    pendingCardIndex = index;
    openColorPicker();
  } else {
    socket.emit('playCard', { roomId: myRoomId, cardIndex: index });
  }
}

function drawCard() {
  if (!gameState?.isYourTurn) return;
  socket.emit('drawCard', { roomId: myRoomId });
}

function callOno() { socket.emit('callUno', { roomId: myRoomId }); }
function catchOno(pid) { socket.emit('catchUno', { roomId: myRoomId, caughtPlayerId: pid }); }

function openColorPicker() {
  document.getElementById('overlay').classList.add('active');
  document.getElementById('colorPicker').classList.add('active');
}

function pickColor(color) {
  document.getElementById('overlay').classList.remove('active');
  document.getElementById('colorPicker').classList.remove('active');
  if (pendingCardIndex !== null) {
    socket.emit('playCard', { roomId: myRoomId, cardIndex: pendingCardIndex, chosenColor: color });
    pendingCardIndex = null;
  }
}

/* â”€â”€â”€ GAME OVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showGameOver(won, subtitle) {
  const panel = document.getElementById('gameOverPanel');
  document.getElementById('gameOverEmoji').textContent = won ? 'ğŸ†' : 'ğŸ˜¢';
  const title = document.getElementById('gameOverTitle');
  title.textContent = won ? 'You Win!' : 'Game Over';
  title.className   = 'game-over-title ' + (won ? 'win' : 'lose');
  document.getElementById('gameOverSub').textContent = subtitle;
  document.getElementById('overlay').classList.add('active');
  panel.classList.add('active');
}

/* â”€â”€â”€ HEARTBEAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startHeartbeat() {
  clearInterval(heartbeatInterval);
  heartbeatInterval = setInterval(() => {
    if (myRoomId) socket.emit('heartbeat', { roomId: myRoomId });
  }, 5000);
}

/* â”€â”€â”€ UTILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAW ANIMATION ENGINE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   Strategy:
   1. Find the discard pile DOM rect (source of the flying cards).
   2. Find the target element rect â€” either an opponent panel
      or the local player's hand.
   3. Spawn N small card divs staggered 80ms apart, each flying
      from source â†’ target using CSS custom properties + keyframes
      injected dynamically.
   4. On the target element: shake animation + burst ring + count pop.
   5. When all cards have landed: flash the target area.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function triggerDrawAnimation(data, isMe) {
  const layer = document.getElementById('animationLayer');

  /* â”€â”€ 1. Source rect (discard pile) â”€â”€ */
  const discardEl = document.getElementById('discardCard');
  const sourceRect = discardEl.getBoundingClientRect();
  const srcX = sourceRect.left + sourceRect.width  / 2;
  const srcY = sourceRect.top  + sourceRect.height / 2;

  /* â”€â”€ 2. Target element â”€â”€ */
  let targetEl, targetRect, targetCX, targetCY;

  if (isMe) {
    // Target is our own hand area
    targetEl = document.getElementById('playerHand');
    if (!targetEl) return;
    targetRect = targetEl.getBoundingClientRect();
    targetCX = targetRect.left + targetRect.width  / 2;
    targetCY = targetRect.top  + targetRect.height / 2;

    // Show "incoming!" label on draw pile zone
    markDrawPileIncoming(data.count);
  } else {
    // Target is the opponent panel
    const panelId = `opp-${data.targetPlayerId}`;
    targetEl = document.getElementById(panelId);
    if (!targetEl) {
      // Fallback: first opponent panel
      targetEl = document.querySelector('.opponent-panel');
    }
    if (!targetEl) return;
    targetRect = targetEl.getBoundingClientRect();
    targetCX = targetRect.left + targetRect.width  / 2;
    targetCY = targetRect.top  + targetRect.height / 2;

    // Show incoming badge on opponent panel
    showIncomingBadge(targetEl, data.count);
  }

  /* â”€â”€ 3. Card color based on played card value â”€â”€ */
  const cardBg = data.cardValue === '+2'     ? '#e63946' :
                 data.cardValue === 'Wild+4' ? 'linear-gradient(135deg,#9b5de5,#4361ee)' :
                 '#555';

  /* â”€â”€ 4. Spawn flying cards â”€â”€ */
  const count   = data.count || 2;
  const flyTime = 480; // ms per card flight

  for (let i = 0; i < count; i++) {
    const delay = i * 90; // stagger each card

    setTimeout(() => {
      spawnFlyingCard(layer, srcX, srcY, targetCX, targetCY, cardBg, flyTime, data.cardValue);
    }, delay);
  }

  /* â”€â”€ 5. Effects on target when first card arrives â”€â”€ */
  setTimeout(() => {
    // Burst ring
    spawnBurstRing(layer, targetCX, targetCY, isMe ? '#e63946' : '#f9a825');

    // Shake the target element
    targetEl.classList.remove('shake');
    void targetEl.offsetWidth; // reflow
    targetEl.classList.add('shake');
    targetEl.addEventListener('animationend', () => targetEl.classList.remove('shake'), { once: true });
  }, flyTime);

  /* â”€â”€ 6. Count pop label when all cards arrive â”€â”€ */
  const totalFlyTime = flyTime + (count - 1) * 90;
  setTimeout(() => {
    spawnCountPop(layer, targetCX, targetCY, count, data.cardValue);
    // Flash local hand
    if (isMe) {
      const hand = document.getElementById('playerHand');
      if (hand) {
        hand.classList.remove('flash-draw');
        void hand.offsetWidth;
        hand.classList.add('flash-draw');
        hand.addEventListener('animationend', () => hand.classList.remove('flash-draw'), { once: true });
      }
    }
    // Remove incoming badge
    setTimeout(() => {
      if (isMe) clearDrawPileIncoming();
      else clearIncomingBadge(targetEl);
    }, 400);
  }, totalFlyTime);

  /* â”€â”€ 7. Toast notification â”€â”€ */
  const who = isMe ? 'You draw' : `${data.targetPlayerName || 'Opponent'} draws`;
  const cardLabel = data.cardValue === '+2' ? '+2' : data.cardValue === 'Wild+4' ? '+4' : `+${count}`;
  const by  = data.playedByName ? ` (${data.playedByName} played ${cardLabel})` : data.isStackedDraw ? ' (stacked!)' : '';
  showToast(`${who} ${count} card${count !== 1 ? 's' : ''}${by}`, 'draw-alert');
}

/* â”€â”€ Spawn one flying card â”€â”€ */
function spawnFlyingCard(layer, x1, y1, x2, y2, bg, duration, cardVal) {
  const card = document.createElement('div');
  card.className = 'fly-card';
  card.style.background = bg;

  // small label
  const valMap = { '+2':'+2', 'Wild+4':'+4' };
  card.textContent = valMap[cardVal] || 'ğŸƒ';

  // Start position (centered on source)
  card.style.left = (x1 - 25) + 'px';
  card.style.top  = (y1 - 37) + 'px';

  layer.appendChild(card);

  // Arc mid-point: go up a bit for a natural arc
  const midX = (x1 + x2) / 2 + (Math.random() - 0.5) * 60;
  const midY = Math.min(y1, y2) - 80 - Math.random() * 40;

  // Use WAAPI for smooth animation
  const dx1 = midX - x1;
  const dy1 = midY - y1;
  const dx2 = x2 - x1;
  const dy2 = y2 - y1;

  card.animate([
    { transform: 'translate(0,0) rotate(0deg) scale(1)',            opacity: 1 },
    { transform: `translate(${dx1}px,${dy1}px) rotate(-20deg) scale(1.1)`, opacity: 1, offset: 0.45 },
    { transform: `translate(${dx2}px,${dy2}px) rotate(15deg) scale(0.7)`, opacity: 0.6 },
  ], {
    duration,
    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
    fill: 'forwards'
  }).onfinish = () => card.remove();
}

/* â”€â”€ Burst ring at target â”€â”€ */
function spawnBurstRing(layer, cx, cy, color) {
  const ring = document.createElement('div');
  ring.className = 'draw-burst';
  ring.style.left = cx + 'px';
  ring.style.top  = cy + 'px';
  ring.style.color = color;
  layer.appendChild(ring);
  ring.addEventListener('animationend', () => ring.remove(), { once: true });
}

/* â”€â”€ Floating "+N" count pop â”€â”€ */
function spawnCountPop(layer, cx, cy, count, cardVal) {
  const pop = document.createElement('div');
  pop.className = 'draw-count-pop';
  pop.textContent = `+${count}`;
  pop.style.left  = cx + 'px';
  pop.style.top   = cy + 'px';
  pop.style.color = cardVal === '+2' ? '#ff6b6b' :
                    cardVal === 'Wild+4' ? '#c77dff' : '#fff';
  layer.appendChild(pop);
  pop.addEventListener('animationend', () => pop.remove(), { once: true });
}

/* â”€â”€ Incoming badge on draw pile (when I'm the victim) â”€â”€ */
function markDrawPileIncoming(count) {
  clearDrawPileIncoming();
  const zone = document.getElementById('drawPileZone');
  const badge = document.createElement('div');
  badge.id = 'drawPileBadge';
  badge.style.cssText = `
    position:absolute;top:-12px;left:50%;transform:translateX(-50%);
    background:linear-gradient(135deg,#e63946,#c1121f);
    color:#fff;font-weight:800;font-size:0.78em;padding:4px 12px;
    border-radius:20px;white-space:nowrap;pointer-events:none;
    box-shadow:0 4px 12px rgba(230,57,70,0.55);
    animation:incoming-pulse 0.6s ease-in-out infinite alternate;
  `;
  badge.textContent = `+${count} incoming!`;
  zone.style.position = 'relative';
  zone.appendChild(badge);
}
function clearDrawPileIncoming() {
  const b = document.getElementById('drawPileBadge');
  if (b) b.remove();
}

/* â”€â”€ Incoming badge on opponent panel â”€â”€ */
function showIncomingBadge(panelEl, count) {
  clearIncomingBadge(panelEl);
  const badge = document.createElement('div');
  badge.className = 'draw-incoming';
  badge.textContent = `+${count} cards!`;
  panelEl.appendChild(badge);
}
function clearIncomingBadge(panelEl) {
  const b = panelEl.querySelector('.draw-incoming');
  if (b) b.remove();
}
</script>

</body>
</html>
